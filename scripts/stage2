#!/bin/bash
set -x
S3_BUCKET={{ bucket_s3 }}
TS=$(date +%Y%m%H%m%S)
LOGFILE=$(echo $TS"_deploy.txt")

INSTANCE_ID=$(curl http://169.254.169.254/latest/meta-data/instance-id)
EC2_AVAIL_ZONE=$(curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone)
EC2_REGION="`echo \"$EC2_AVAIL_ZONE\" | sed -e 's:\([0-9][0-9]*\)[a-z]*\$:\\1:'`"

TAGS=$(/usr/local/bin/aws ec2 describe-tags --filters "Name=resource-id,Values=$INSTANCE_ID" --region "$EC2_REGION")
NAME=$(echo $TAGS | jq -r ".Tags[] | { key: .Key, value: .Value } | [.] | from_entries" | jq -r '.["Name"] | select (.!=null)')
ROLE=$(echo $TAGS | jq -r ".Tags[] | { key: .Key, value: .Value } | [.] | from_entries" | jq -r '.["role"] | select (.!=null)')
ENV=$(echo $TAGS | jq -r ".Tags[] | { key: .Key, value: .Value } | [.] | from_entries" | jq -r '.["env"] | select (.!=null)')
APP=$(echo $TAGS | jq -r ".Tags[] | { key: .Key, value: .Value } | [.] | from_entries" | jq -r '.["app"] | select (.!=null)')

if [ ! -d /ghost ]; then
    mkdir /ghost && chown -R admin:admin /ghost
fi

if [ ! -d /var/lib/ghost ]; then
    mkdir /var/lib/ghost
fi

function zabbix_hostname(){
    #Update Zabbix agent name
    IP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4 | tr -s '.' '-')
    sed -i "s/.*Hostname=.*/&-${IP}/g" /etc/zabbix/zabbix_agentd.conf
    service zabbix-agent restart
}

if [ -z "$1" ] ; then
    zabbix_hostname
fi

function purge_latest_failed_deploy() {
    MODULE_NAME=$1
    MODULE_PATH=/ghost/$2
    FAILED="_failed"
    MODULE_FAILED=/var/lib/ghost/$MODULE_NAME$FAILED

    if [ -e $MODULE_FAILED ]; then
        MODULE_TO_DELETE=$(head -n 1 $MODULE_FAILED)
        echo "Purging latest failed module: $MODULE_TO_DELETE" >> /tmp/$LOGFILE
        rm -rf $MODULE_TO_DELETE
        # Remove deleted module from history
        sed -i 1d $MODULE_FAILED
    fi
    # Append fail to the failed module deployment history
    echo $MODULE_PATH >> $MODULE_FAILED
}

function purge_oldest_succeed_deploy() {
    MODULE_NAME=$1
    MODULE_PATH=/ghost/$2
    SUCCEED="_succeed"
    MODULE_SUCCEED=/var/lib/ghost/$MODULE_NAME$SUCCEED
    MAX_DEPLOY_HISTORY="3"

    if [ -e $MODULE_SUCCEED ]; then
        NUM_OF_DEPLOY=$(wc -l < $MODULE_SUCCEED)
        if [ $NUM_OF_DEPLOY -gt $MAX_DEPLOY_HISTORY ]; then
            MODULE_TO_DELETE=$(head -n 1 $MODULE_SUCCEED)
            echo "Purging oldest succeed module: $MODULE_TO_DELETE" >> /tmp/$LOGFILE
            rm -rf $MODULE_TO_DELETE
            # Remove deleted module from history
            sed -i 1d $MODULE_SUCCEED
        fi
    fi
    # Append succeed to the succeed module deployment history
    echo $MODULE_PATH >> $MODULE_SUCCEED
}

function deploy_module() {
    MODULE_NAME=$1
    MODULE_FILE=$2
    TARGET=$3
    echo "--------------------------------" >> /tmp/$LOGFILE
    echo "Deploying module $MODULE_NAME in $TARGET" >> /tmp/$LOGFILE
    /usr/local/bin/aws s3 cp s3://$S3_BUCKET/ghost/$APP/$ENV/$ROLE/$MODULE_NAME/$MODULE_FILE /tmp/$MODULE_FILE  --region "$EC2_REGION"

    if [ -d /ghost/$MODULE_FILE ]; then
        echo "Module already exist...Exiting" >> /tmp/$LOGFILE
        exit -1
    fi

    mkdir -p /ghost/$MODULE_FILE
    chown -R admin:admin /ghost/$MODULE_FILE
    echo "Extracting module in /ghost/$MODULE_FILE" >> /tmp/$LOGFILE
    tar xvzf /tmp/$MODULE_FILE -C /ghost/$MODULE_FILE > /dev/null
    rm -rf /tmp/$MODULE_FILE
    cd /ghost/$MODULE_FILE

    if [ -e predeploy ]
    then
        echo "Executing predeploy script..." >> /tmp/$LOGFILE
        chmod +x predeploy
        ./predeploy >> /tmp/$LOGFILE 2>&1
        local status=$?
        if [ $status -ne 0 ]; then
            purge_latest_failed_deploy $MODULE_NAME $MODULE_FILE
            exit -1
        fi
    fi

    # Clear folder if not a symlink (not a Ghost managed module)
    if ! [ -h $TARGET ]
    then
        echo "Clearing unmanaged folder..." >> /tmp/$LOGFILE
        rm -rfv $TARGET
    fi

    # Replace old module after pre-deploy and before post-deploy
    ln -fsn /ghost/$MODULE_FILE $TARGET
    cd $TARGET

    if [ -e postdeploy ]
    then
        echo "Executing postdeploy script..." >> /tmp/$LOGFILE
        chmod +x postdeploy
        ./postdeploy >> /tmp/$LOGFILE 2>&1
    fi

    purge_oldest_succeed_deploy $MODULE_NAME $MODULE_FILE
}

function find_module() {
    for line in $(cat /tmp/MANIFEST)
      do
        MODULE_NAME=$(echo $line | awk -F':' '{print $1}')
        MODULE_FILE=$(echo $line | awk -F':' '{print $2}')
        TARGET=$(echo $line | awk -F':' '{print $3}')
	    if [ "$1" == "$MODULE_NAME" ]; then
            echo $MODULE_NAME $MODULE_FILE $TARGET
        fi
    done
}

function exit_deployment() {
    echo "Removing Manifest file" >> /tmp/$LOGFILE
    rm /tmp/MANIFEST
    exit $1
}

echo "Downloading Manifest" >> /tmp/$LOGFILE
/usr/local/bin/aws s3 cp s3://$S3_BUCKET/ghost/$APP/$ENV/$ROLE/MANIFEST /tmp/ --region "$EC2_REGION"

if [ $? -ne 0 ]; then
    echo "Manifest download error...Exiting" >> /tmp/$LOGFILE
    # init zabbix before quit
    exit_deployment 10
fi

# Deploy only one module
if [ -n "$1" ]; then
    MODULE=$(find_module $1)
    deploy_module $MODULE
    exit_deployment 0
fi

# Deploying all modules
for line in $(cat /tmp/MANIFEST)
do
    MODULE_NAME=$(echo $line | awk -F':' '{print $1}')
    MODULE_FILE=$(echo $line | awk -F':' '{print $2}')
    TARGET=$(echo $line | awk -F':' '{print $3}')
    deploy_module $MODULE_NAME $MODULE_FILE $TARGET
done
